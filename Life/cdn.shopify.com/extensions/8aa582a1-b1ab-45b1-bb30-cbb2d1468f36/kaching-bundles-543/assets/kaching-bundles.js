!function(){"use strict";const t=(()=>{try{const t="kaching_local_storage_test";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}})()?window.localStorage:window.sessionStorage,n=()=>new URLSearchParams(window.location.search).get("kaching");let i;let e;const o=()=>(void 0===e&&(e="debug"===n()),e);let s;const a=async(t,n,i)=>{const e=`https://${t||"bundles.kachingappz.app"}/storefront_api/${n}`,o={...i,shop:window.Shopify.shop,version:S()};return await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})},r=async(n,i,e,o,s)=>{try{const a="kaching_visited_deal_blocks",r=t.getItem(a),c=r?JSON.parse(r):[];if(c.includes(i))return;c.push(i),t.setItem(a,JSON.stringify(c));const u=`${"https://kaching-bundles-stats-50cc8a504c1c.herokuapp.com"}/impressions`;await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shopDomain:n,dealBlockId:i,productId:e,abTestVariantId:o,sessionId:s})})}catch(a){console.error(a)}},c=async(t,n,i={},e=1)=>{if(Math.random()>e)return;l("sendStorefrontEvent",{name:n,data:i});const o=window.location.href;return await a(t,"events",{event:{name:n,data:i,url:o}})},u=async(t,n,i,e)=>{if("Failed to fetch"===i)return;const o=window.location.href;return await a(t,"errors",{error:{filename:n,message:i,stack:e,url:o}})},d=t=>{const n=["kaching-bundles.js","kaching-bundles-block.js"];window.addEventListener("error",(async function(i){try{await(async i=>{const{filename:e,message:s,error:a}=i;for(const r of n)if(e.includes(r)){if(o())return void l("Error",i);await u(t,e,s,a.stack)}})(i)}catch(e){console.error(e)}})),window.addEventListener("unhandledrejection",(async function(i){try{await(async i=>{if("object"!=typeof i.reason)return;const{message:e,stack:s}=i.reason;if(s)for(const a of n)if(s.includes(a)){if(o())return void l("Unhandled rejection",i);await u(t,a,e,s)}})(i)}catch(e){console.error(e)}}))};function l(t,i=null){(o()||(void 0===s&&(s="dev"===n()),s))&&console.debug("[Kaching Bundles]",t,i)}const h=()=>{const t=t=>{window.dispatchEvent(new Event(t))},n=history.pushState;history.pushState=function(...i){const e=n.apply(this,i);return t("pushstate"),t("locationchange"),e};const i=history.replaceState;history.replaceState=function(...n){const e=i.apply(this,n);return t("replacestate"),t("locationchange"),e},w(window,"popstate",(()=>{t("locationchange")}))},p=(t,n,i,e=0)=>{const o=Object.getPrototypeOf(t);if(o.hasOwnProperty(n)){const s=Object.getOwnPropertyDescriptor(o,n);if(!s.configurable)return;Object.defineProperty(t,n,{configurable:!0,get:function(...t){return s.get.apply(this,t)},set:function(...t){const o=this[n];s.set.apply(this,t);const a=this[n];return"function"==typeof i&&setTimeout(i.bind(this,o,a),e),a}})}},f=(t,n=document.body)=>n.querySelector(t),m=(t,n=document.body)=>[...n.querySelectorAll(t)],w=(t,n,i)=>t.addEventListener(n,i),y=t=>document.createElement(t),_=(t,n,i)=>t.setAttribute(n,i),b=t=>t.dataset,g=t=>{const n=f(t);if(!n)return;const i=JSON.parse(n.textContent);return l("jsonFromElement",i),i},v=(t,n)=>{let i=0,e=t;for(;e!==n&&e!==document.body;)i++,e=e.parentNode;if(e!==n)throw new Error("The specified child node is not a descendant of the parent node.");return i},k=(t,n)=>{const i=new Range;return i.setStart(t,0),i.setEnd(n,0),i.collapsed&&(i.setStart(n,0),i.setEnd(t,0)),i.commonAncestorContainer},I=(t,n,i=1/0)=>{let e=null,o=1/0;for(const s of n){const n=k(t,s),a=v(t,n);a>i||a<o&&(e=s,o=a)}return e},S=()=>{const t=document.currentScript;if(!t)return null;const n=t.src.match(/\/([^/]+)\/assets\//);return n&&n[1]?n[1]:null},q=t=>{const n=window.Shopify.routes;return(n&&n.root||"/")+t},C=(t,n)=>{new MutationObserver(((i,e)=>{for(const o of i)"childList"===o.type&&o.removedNodes.forEach((i=>{i.contains(t)&&(e.disconnect(),n())}))})).observe(document.body,{childList:!0,subtree:!0})},T=[['[data-icon="gpicon-product-cartbutton"]','[data-icon="gpicon-product-quantity"]'],["gp-product-button","gp-product-quantity"],["product-form",".product-form__quantity"],['[data-pf-type="ProductATC"]','[data-pf-type="ProductQuantity"]'],[".product-form__item--submit",'label[for="Quantity-product-template"]'],[".product-single__add-to-cart",".product-single__quantity"],[".product-info__buy-buttons",".product-info__quantity-selector"],[".ProductForm__BuyButtons, .ProductForm__AddToCart",".ProductForm__QuantitySelector"],['[data-block-type="buy-buttons"]','[data-block-type="quantity-selector"]'],[".product-page--submit-action",".quantity-controls__outer"],[".product-form__payment-container",".product-form__info-item--quantity"],["[data-product-submit]",".product-quantity-input"],[".product-form--atc",".product-form--atc-qty"],[".purchase-details",".purchase-details__quantity"],[".product-single__form .payment-buttons",".product__quantity"],[".product-form--wide",".product-single__quantity"],[".product-single__add-to-cart",".product-single__quantity"],[".product-form--button-container",null],[".product-form__item--submit",".product-form__item--quantity"],[".product-detail__form__action",null],[".product__submit__buttons",null],[".buy-buttons-row",".quantity-wrapper"],[".t4s-product-form__buttons","[data-quantity-wrapper]"],[".qty-wrapper--with-payment-button",".product-qty"],[".shopify-product-form",".product-quantity-block"],[".shopify-product-form",".product-block-quantity-selector"],[".type_buy_buttons",".type_quantity_selector"],[".product-single__form .add-to-cart",".product__quantity"],[".purchase-section",".quantity.form"],[".product-form__buttons",".quantity_selector"],[".product__atc",".quantity--input"],[".product-form__payment-container",".quantity-selector"],[".ecom-product-single__add-to-cart",".ecom-product-single__quantity"],[".product-form__submit",".product__quantity"],[".product-info__add-to-cart","quantity-input"],[".yv-checkout-btn",".yv-product-quantity"],[".product-add-to-cart-container","quantity-selector"],[".product__block__buttons",".product__block__quantity"]];class P extends Error{constructor(t){super(t),this.name="CartFetchError"}}const N="kaching_session_id",$=()=>{const n=new URL(window.location.href),i=new URLSearchParams(n.search).get("preview_kaching_session_id");i&&t.setItem(N,i)},F=()=>t.getItem(N)||V(),V=()=>{const n=window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():A();return t.setItem(N,n),n},A=()=>"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(t=>(+t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>+t/4).toString(16))),O=async()=>{const t=await fetch(q("cart.js"));if(!t.ok)throw new P("Failed to fetch cart");return(await t.json()).attributes.__kaching_session_id},x=async t=>{const n=new FormData;n.append("attributes[__kaching_session_id]",t);const i=await fetch(q("cart/update.js"),{method:"POST",body:n});return await i.json()},B=(t,n)=>{const i=t.slice(-1);return parseInt(i,16)%n+1};class j{constructor(t,n,i,e,o){if(l("AddToCartForm",[t]),this.t=t,this.i=n,this.o=i,this.u=e,o){this.l("properties[__kaching_session_id]").value=F()}}update(t){if(l("AddToCartForm#update",[this.t,t]),1===t.length||this.u){const n=t.find((t=>t.variantId==this.currentVariantId()))||t[0],{variantId:i,quantity:e}=n;this.h({variantId:i,quantity:e})}else t.length>1&&this.p(t)}legacyFormData(){const t=new FormData(this.t);return t.has("items[0][id]")&&(t.delete("id"),t.delete("quantity")),t}currentVariantId(){const t=this.m("id");if(t)return Number(t.value)}h(t){this._();const{variantId:n,quantity:i}=t,e=this.l("id");e.disabled=!1,e.value=String(n),l("AddToCartForm#_addSingleVariantToCartForm",{idInput:e,variantId:n}),this.v(i)}v(t){l("AddToCartForm#_updateQuantityInput",t);let n=null;n=this.o?this.l("quantity"):this.m("quantity"),n&&(n.disabled=!1,n.value=String(t))}p(t){this._();for(const[n,i]of t.entries()){const{variantId:t,quantity:e}=i;this.l(`items[${n}][id]`).value=String(t);this.l(`items[${n}][quantity]`).value=String(e)}this.k()}k(){const t=this.m("id");t&&(t.disabled=!0);const n=this.m("quantity");n&&(n.disabled=!0)}_(){const t=m('input[name^="items"]',this.t);for(const n of t)n.remove()}l(t){if("ef847e-2.myshopify.com"===window.Shopify.shop&&"id"===t){const n=this.m(t);if(n)return n;const i=f(`input[name="${t}"]`);return i||this.I(t)}return this.m(t)||this.I(t)}m(t){return f(`[name="${t}"]`,this.t)}I(t){const n=y("input");return n.type="hidden",n.name=t,this.t.prepend(n),n}}const D="2024-07",Q=async({storefrontAccessToken:t,country:n,language:i,productIds:e,removeUnavailableVariants:o=!1})=>{const s=e.map((t=>`gid://shopify/Product/${t}`)),a=await fetch(`/api/${D}/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Storefront-Access-Token":t},body:JSON.stringify({query:`\n        query($productGIDs: [ID!]!) @inContext(country: ${n}, language: ${i}) {\n          nodes(ids: $productGIDs) {\n            ... on Product {\n              id\n              handle\n              onlineStoreUrl\n              availableForSale\n              title\n              featuredImage {\n                url\n              }\n              options {\n                name\n                optionValues {\n                  id\n                  name\n                  swatch {\n                    color\n                    image {\n                      previewImage {\n                        url(transform: { maxWidth: 200, maxHeight: 200 })\n                      }\n                    }\n                  }\n                }\n              }\n              variants(first: 250) {\n                edges {\n                  node {\n                    id\n                    availableForSale\n                    price {\n                      amount\n                    }\n                    compareAtPrice {\n                      amount\n                    }\n                    selectedOptions {\n                      name\n                      value\n                    }\n                    image {\n                      id\n                      url(transform: { maxWidth: 200, maxHeight: 200 })\n                    }\n                  }\n                }\n              }\n              collections(first: 50) {\n                edges {\n                  node {\n                    id\n                  }\n                }\n              }\n              metafield: metafield(namespace: "$app:kaching_bundles", key: "text") {\n                value\n              }\n              metafield2: metafield(namespace: "$app:kaching_bundles", key: "text2") {\n                value\n              }\n              metafield3: metafield(namespace: "$app:kaching_bundles", key: "text3") {\n                value\n              }\n              metafield4: metafield(namespace: "$app:kaching_bundles", key: "text4") {\n                value\n              }\n              legacy_metafield_text: metafield(namespace: "kaching_bundles", key: "text") {\n                value\n              }\n              legacy_metafield_text2: metafield(namespace: "kaching_bundles", key: "text2") {\n                value\n              }\n            }\n          }\n        }\n      `,variables:{productGIDs:s}})});return(await a.json()).data.nodes.filter((t=>null!=t)).map((t=>J(t,o)))},J=(t,n)=>{var i,e,o,s,a,r,c;let u=t.variants.edges.map((t=>t.node)).map((t=>{var n;return{id:Number(t.id.split("/").pop()),availableForSale:t.availableForSale,price:Math.round(100*Number(t.price.amount)),compareAtPrice:t.compareAtPrice?Math.round(100*Number(t.compareAtPrice.amount)):null,options:t.selectedOptions.map((t=>t.value)),imageId:t.image?Number(t.image.id.split("/").pop()):null,image:(null==(n=t.image)?void 0:n.url)||null}}));n&&(u=u.filter((t=>t.availableForSale)));const d=t.options.map(((t,n)=>{const i=t.optionValues.map((t=>{var n,i,e,o;return{id:Number(t.id.split("/").pop()),defaultName:t.name,name:t.name,swatch:{color:(null==(n=t.swatch)?void 0:n.color)||null,image:(null==(o=null==(e=null==(i=t.swatch)?void 0:i.image)?void 0:e.previewImage)?void 0:o.url)||null}}}));return{defaultName:t.name,name:t.name,position:n+1,optionValues:R(i,n,u)}}));return{id:Number(t.id.split("/").pop()),url:t.onlineStoreUrl,availableForSale:t.availableForSale,title:t.title,image:(null==(i=t.featuredImage)?void 0:i.url)||null,collectionIds:t.collections.edges.map((t=>Number(t.node.id.split("/").pop()))),options:d,selectedVariantId:Number(t.variants.edges[0].node.id.split("/").pop()),variants:u,metafields:{text:(null==(e=t.metafield)?void 0:e.value)||null,text2:(null==(o=t.metafield2)?void 0:o.value)||null,text3:(null==(s=t.metafield3)?void 0:s.value)||null,text4:(null==(a=t.metafield4)?void 0:a.value)||null},legacyMetafields:{kaching_bundles:{text:(null==(r=t.legacy_metafield_text)?void 0:r.value)||null,text2:(null==(c=t.legacy_metafield_text2)?void 0:c.value)||null}}}},R=(t,n,i)=>t.filter((t=>i.filter((i=>i.options[n]===t.name)).length>0)),E=async(t,n)=>{const i=`https://${t||"bundles.kachingappz.app"}/storefront_api/deal_blocks?shop=${n}`,e=await fetch(i);return(await e.json()).deal_blocks},M=async t=>{var n;const i=await fetch(`/api/${D}/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Storefront-Access-Token":t},body:JSON.stringify({query:'\n        {\n          shop {\n            metafield(namespace: "$app:kaching_bundles", key: "deal_blocks") {\n              value\n            }\n          }\n        }\n      '})}),e=null==(n=(await i.json()).data.shop.metafield)?void 0:n.value;return e?JSON.parse(e):[]},U=async(t,n,i=200)=>{const e=await fetch(`/api/${D}/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Storefront-Access-Token":t},body:JSON.stringify({query:"\n        query mediaImages($mediaImageIds: [ID!]!, $size: Int!) {\n          nodes(ids: $mediaImageIds) {\n            ... on MediaImage {\n              id\n              image {\n                url(transform: { maxWidth: $size, maxHeight: $size })\n              }\n            }\n          }\n        }\n      ",variables:{mediaImageIds:n,size:i}})});return(await e.json()).data.nodes.filter(Boolean).map((t=>({gid:t.id,url:t.image.url})))},L=t=>{const n=t.options.map(((t,n)=>({defaultName:t.name,position:n+1,optionValues:t.optionValues.map((t=>({id:Number(t.id.split("/").pop()),defaultName:t.name})))})));return{id:Number(t.id.split("/").pop()),options:n}},z=async(t,n)=>{const i=n.dealBars.map((t=>t.mediaImageGID)).filter((t=>null!=t)).filter((t=>!t.includes("placeholder")));if(!i.length)return[];return await U(t,i,300)},G=async(t,n)=>{const i=n.dealBars.map((({freeGift:t})=>null==t?void 0:t.mediaImageGID)).filter((t=>null!=t)).filter((t=>!t.includes("placeholder")));if(!i.length)return[];return await U(t,i,300)},H=async(t,n)=>{const i=n.dealBars.map((({upsell:t})=>null==t?void 0:t.mediaImageGID)).filter((t=>null!=t));if(!i.length)return[];return await U(t,i,300)},X=async(t,n)=>{if(!n.swatchOptions)return[];const i=n.swatchOptions.reduce(((t,n)=>[...t,...n.images.map((t=>t.mediaImageGID)).filter((t=>null!=t))]),[]);if(!i.length)return[];return await U(t,i)},W=window;class K{constructor(t,n,i,e,o,s,a,r,c){this.S=null,this.q=null,this.C=[],this.T=null,this.P=null,l("DealBlock",{dealBlock:t,cartForm:n,addToCartButton:i,quantityInput:e,variantPicker:o,globalConfig:s,translations:a,dealBlockSettings:r,product:c}),this.N=t,this.t=n,this.$=i,this.F=e,this.V=o,this.A=s,this.O=a,this.B=r,this.i=c,this.j=this.i.selectedVariantId||this.i.variants[0].id,this.D=n&&new j(n,c,!e,s.addDifferentVariantsToCartSeparately,!!r.abTestVariantNumber),this.J()}updateVariantPicker(t){this.V=t}updateAddToCartButton(t){this.$=t,this.R()}updateQuantityInput(t){this.F=t,this.M()}J(){_(this.N,"config",JSON.stringify(this.A)),_(this.N,"translations",JSON.stringify(this.O)),_(this.N,"deal-block",JSON.stringify(this.B)),_(this.N,"product",JSON.stringify(this.i)),_(this.N,"current-variant-id",String(this.j)),this.U(),this.L(),this.t&&(this.$||"119a01-bf.myshopify.com"===window.Shopify.shop)&&this.G()}async U(){const t=await(async(t,n)=>{const[i,e,o,s]=await Promise.all([z(t,n),G(t,n),H(t,n),X(t,n)]);return[...i,...e,...o,...s]})(this.A.storefrontAccessToken,this.B);_(this.N,"media-images",JSON.stringify(t))}async L(){const t=this.B.dealBars.map((({freeGift:t})=>null==t?void 0:t.productGID)).filter((t=>null!=t)),n=this.B.dealBars.map((({upsell:t})=>null==t?void 0:t.productGID)).filter((t=>null!=t)),i=this.B.dealBars.map((({bundleProducts:t})=>t?t.map((t=>t.productGID)):[])).reduce(((t,n)=>t.concat(n)),[]).filter((t=>null!=t)).filter((t=>"default"!==t)),e=Array.from(new Set([...t,...n,...i]));if(!e.length)return;const o=await Q({storefrontAccessToken:this.A.storefrontAccessToken,country:window.Shopify.country,language:window.Shopify.locale.split("-")[0].toUpperCase(),productIds:e.map((t=>Number(t.split("/").pop()))),removeUnavailableVariants:!0});_(this.N,"other-products",JSON.stringify(o))}G(){this.H(),this.X(),this.W(),this.M(),this.K(),this.Z(),this.Y(),window.kachingBundlesDisableAddToCartHandling||(this.A.addDifferentVariantsToCartSeparately?this.R():this.tt())}H(){h(),w(W,"locationchange",(()=>{const t=new URLSearchParams(W.location.search).get("variant");t&&this.nt(Number(t))}))}X(){const t=f('input[name="id"]',this.t);t&&p(t,"value",((t,n)=>{l("_listenForVariantIdInputChange",[t,n]),t!==n&&n&&this.nt(Number(n))}))}W(){const t=f('select[name="id"]',this.t);if(!t)return;let n;window.setInterval((()=>{const i=t.value;n!==i&&i&&(l("_listenForVariantIdSelectChange",[n,i]),n=i,this.nt(Number(i)))}),100)}nt(t){t!=this.j&&(this.j=t,this.N.dataset.nativeVariantChangeInProgress||window.kachingBundlesVariantChangeInProgress||(l("handleNativeVariantChange",t),this.N.dataset.nativeVariantChangeInProgress="true",setTimeout((()=>{delete this.N.dataset.nativeVariantChangeInProgress}),500),this.i.variants.find((n=>n.id==t))&&_(this.N,"current-variant-id",String(t))))}M(){this.F&&(w(this.F,"change",(()=>{const t=Number(this.F.value);l("_listenForQuantityInputChange change",t),this.it(t)})),p(this.F,"value",((t,n)=>{t!==n&&(l("_listenForQuantityInputChange observe",[t,n]),this.it(Number(n)))})))}it(t){window.kachingBundlesQuantityChangeInProgress||(!this.A.keepQuantityInput||window.kachingBundlesVariantChangeInProgress||this.N.dataset.nativeVariantChangeInProgress?this.et&&this.et.length&&this.v(this.et):this.A.keepQuantityInput&&_(this.N,"quantity",String(t)))}v(t){if(!this.F)return;window.kachingBundlesQuantityChangeInProgress=!0;let n=t.reduce(((t,n)=>t+n.quantity),0);if(this.A.addDifferentVariantsToCartSeparately){const i=this.D.currentVariantId();n=(t.find((({variantId:t})=>t==i))||t[0]).quantity}l("_updateQuantityInput",n),this.F.value=String(n),"119a01-bf.myshopify.com"===window.Shopify.shop&&this.F.dispatchEvent(new Event("input",{bubbles:!0})),this.F.dispatchEvent(new Event("change",{bubbles:!0})),setTimeout((()=>{delete window.kachingBundlesQuantityChangeInProgress}),100)}K(){this.V&&w(this.N,"variant-selected",(t=>{const{variantId:n}=t.detail,i=this.i.variants.find((t=>t.id==n));l("listenForBlockVariantSelect",[n,i]);if(["054d81.myshopify.com","28212b.myshopify.com","79ad13-4.myshopify.com","value-deal-offers.myshopify.com","countrydale.myshopify.com","cbbd15.myshopify.com"].includes(window.Shopify.shop)||i.imageId&&i.imageId!=this.P){this.P=i.imageId,this.j=n,this.ot();for(const[t,n]of i.options.entries()){const e=this.i.options[t],o=e.name,s=e.optionValues.find((t=>t.name===n)).id;this.V.select(t+1,s,o,n,this.i.id,i.id)}}}))}Z(){w(this.N,"variants-changed",(t=>{var n;clearTimeout(this.st);const{variantIdQuantities:i,freeGift:e,upsell:o,bundleProducts:s,formattedPrice:a,preselected:r}=t.detail;l("listenForBlockVariantsChange",{variantIdQuantities:i,freeGift:e,upsell:o,bundleProducts:s,formattedPrice:a,preselected:r}),this.ot(),this.D.update(i),this.et=i,this.S=e,this.q=o,this.C=s,this.v(i),null==(n=this.$)||n.updatePrice(a),r&&setTimeout((()=>{var t;return null==(t=this.$)?void 0:t.updatePrice(a)}),300),this.rt(),r&&(this.st=setTimeout((()=>{this.v(i),delete this.st}),1e3))}))}Y(){w(this.N,"deal-bar-selected",(t=>{const{dealBarId:n}=t.detail;l("_listenForDealBarSelect",n),this.T=n}))}ot(){clearTimeout(window.kachingBundlesVariantChangeInProgress),window.kachingBundlesVariantChangeInProgress=setTimeout((()=>{delete window.kachingBundlesVariantChangeInProgress}),500)}R(){if(!this.$)return;this.$.onClickIfConditionMet((()=>!window.kachingBundlesDisableAddToCartHandling&&(!!this.B.skipCart||(!!this.S||(!!this.q||(this.C.length>0||(!!this.ct()||!!this.et&&!(this.et.length<2))))))),(async()=>{if(this.B.skipCart)return await this.ut(),void(window.location.href=q("checkout"));if(this.ct()){try{window.upcartOpenCart&&window.upcartOpenCart()}catch(t){console.error("upcartOpenCart error",t)}return await this.ut(),void(window.upcartRefreshCart&&window.upcartRefreshCart())}return this.dt()}),(()=>this.B.skipCart||this.ct())),this.lt()}lt(){window.upcartShouldSkipAddToCartInterceptor=!0;const t=window.upcartShouldSkipAddToCart;window.upcartShouldSkipAddToCart=n=>{if("function"==typeof t){if(!0===t(n))return!0}return n.includes("kaching_bundles=true")}}ct(){return!!f("#UpcartPopup")||!!window.upcartDocumentOrShadowRoot}async dt(){l("addVariantsExceptCurrentToCart",this.et);const t=this.D.currentVariantId(),n=this.et.filter((({variantId:n})=>n!=t))||this.et[0];await this.ht(n)}async ut(){l("addAllVariantsToCart",this.et);let t=this.et;t||(t=[{variantId:this.D.currentVariantId(),quantity:1}]),await this.ht(t)}ft(){const t=m('[name^="properties"]').map((t=>[t.name.match(/properties\[(.*)\]/)[1],t.value]));return Object.fromEntries(t)}async ht(t){const n=this.ft(),i=t.map((({variantId:t,quantity:i})=>({id:t,quantity:i,properties:n})));this.S&&i.push({id:this.S.variantId,quantity:this.S.quantity,properties:{__kaching_free_gift:!0,__kaching_free_gift_deal_block_id:this.B.id}}),this.q&&i.push({id:this.q.variantId,quantity:this.q.quantity,properties:{__kaching_upsell_deal_block_id:this.B.id}});for(const[e,{variantId:o,quantity:s}]of this.C.entries())i.push({id:o,quantity:s,properties:{__kaching_bundle:JSON.stringify({dealBlockId:this.B.id,dealBarId:this.T,bundleProductIndex:e+1,defaultProductId:this.i.id})}});l("makeAddToCartRequest",{items:i}),await fetch(q("cart/add.js?kaching_bundles=true"),{method:"POST",body:JSON.stringify({items:i}),headers:{"Content-Type":"application/json"}})}tt(){this.$&&(w(this.$.element,"click",(t=>{l("Add to cart button click event (legacy)",t),this.wt(t)})),w(this.t,"submit",(t=>{l("Add to cart form submit event (legacy)",t),this.wt(t)})))}async wt(t){l("legacyHandleCartSubmit",this.et),this.A.multivariantCartDrawer||this.et&&(this.et.length<2||(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),await this.yt(),W.location.href=q("cart")))}async yt(){const t=this.D.legacyFormData();if(this.A.useLineItemProperties)for(const[i,e]of this._t())t.set(i,e);l("legacyMakeAddToCartRequest",t);const n=await fetch(q("cart/add.js?kaching_bundles=true"),{method:"POST",body:t});return await n.json()}_t(){if(!this.et||this.et.length<2)return[];const t=[],n=m('[name^="properties"]').map((t=>[t.name.match(/properties\[(.*)\]/)[1],t.value]));for(const[i]of this.et.entries())for(const[e,o]of n)t.push([`items[${i}][properties][${e}]`,o]);return t}rt(){if(!this.et)return;const t="kaching-bundles-form--different-variants-selected";this.et.length>1||this.S||this.q||this.C.length>0?this.t.classList.add(t):this.t.classList.remove(t)}}class Z{static find(t){let n=t.parentElement;for(;n;){const t=f('variant-selects, variant-radios, variant-picker, product-variants, gp-product-variants, .gf_variants-wrapper, [data-pf-type="ProductVariantSwatches"], .product-selectors, .product-block-variant-picker',n);if(t)return new Z([t]);let i=m(".selector-wrapper, .radio-wrapper, .variant-wrapper, div[data-product-option]",n);if(["28212b.myshopify.com","9bd9ad.myshopify.com"].includes(window.Shopify.shop)&&(i=m(".selector-wrapper, .radio-wrapper, .variant-wrapper, .select-wrapper, div[data-product-option]",n)),i.length){const t=i.filter((t=>!i.some((n=>n!==t&&n.contains(t)))));return new Z(t)}n=n.parentElement}return null}constructor(t){this.bt=t}elements(){return this.bt}hide(){for(const t of this.bt)t.style.display="none",t.parentElement.classList.add("kaching-bundles--variant-selects-hidden")}select(t,n,i,e,o,s){l("VariantPicker#select",[t,n,i,e]),this.gt(t,n,i,e,o)||this.vt(t,i,e)||this.kt(s)}gt(t,n,i,e,o){const s=this.bt.map((t=>[...t.querySelectorAll("input")])).flat();let a=s.filter((n=>[i,`${i}-${t}`,`options[${i}]`,`option${t}`,`option-${o}-${t-1}`].includes(n.name.trim())));a.length||(a=s.filter((n=>!!n.dataset.optionPosition&&Number(n.dataset.optionPosition)===t)));const r=a.find((t=>t.value==e||t.value===String(n)));return!!r&&(l("VariantPicker#_clickRadioInput",r),r.click(),!0)}vt(t,n,i){const e=this.bt.map((t=>[...t.querySelectorAll("select")])).flat().find((i=>!![`options[${n}]`,`option${t}`].includes(i.name)||(i.dataset.index===`option${t}`||(i.dataset.optionName===n||(i.id==="SingleOptionSelector-product-"+(t-1)||i.id===`p-variant-dropdown-${t}`)))));if(!e)return!1;return!![...e.options].find((t=>t.value==i))&&(l("VariantPicker#_setSelectValue",{variantSelect:e,optionValue:i}),e.value=i,e.dispatchEvent(new Event("change",{bubbles:!0})),!0)}kt(t){const n=this.bt.map((t=>[...t.querySelectorAll("select")])).flat().find((n=>[...n.options].find((n=>Number(n.value)===t))));return!!n&&(l("VariantPicker#_setSelectVariantId",{variantSelect:n,variantId:t}),n.value=String(t),n.dispatchEvent(new Event("change",{bubbles:!0})),!0)}}class Y{constructor(t){this.It=!1,this.St=!1,this.element=t}onClickIfConditionMet(t,n,i){this.element.addEventListener("click",(async e=>{const o=t(),s=i();l("AddToCartButton#interceptClick",{conditionMet:o,preventDefault:s,submitInProgress:this.It,ignoreClick:this.St}),o&&(this.It?this.It=!1:this.St||(this.It=!0,this.St=!0,this.element.disabled=!0,setTimeout((()=>{this.St=!1}),1e3),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),await n(),this.element.disabled=!1,s?this.It=!1:this.element.click()))}),!0)}updatePrice(t){const n=this.qt(this.element);n&&(n.innerHTML=t)}qt(t){if(!t.childNodes.length)return null;const n=t.childNodes[0].nodeValue;if(n&&n.match(/\d/)&&!n.match(/[a-zA-Z]{4}/))return t;for(const i of t.childNodes){const t=this.qt(i);if(t)return t}return null}}const tt=['[data-pf-type^="ProductATC"]',"button.gp-button-atc","gp-product-button button",'button[type="submit"]','input[type="submit"]'],nt=['form[action*="/cart/add"]',"form[data-instant-form-product-url]"],it=()=>{"visualPreviewInitialLoad"!==new URLSearchParams(window.location.search).get("source")&&console.log('%c❗ [Kaching Bundles] Please add "Add to cart" button to the page template',"color: white; font-weight: bold; background: linear-gradient(90deg, #8181d7, #93e9e5); padding: 5px 8px; border-radius: 3px;")};class et{constructor(t,n,i,e,o){this.F=null,this.V=null,this.$=null,this.A=n,this.O=i,this.B=e,t.innerHTML='<kaching-bundles-block class="kaching-bundles"></kaching-bundles-block>',b(t).initialized="true",this.N=f("kaching-bundles-block",t),this.t=this.Ct(),this.Tt(),this.Pt(),this.Nt(),this.$t(),this.Ft(),this.Vt(),this.At(),this.Ot=new K(this.N,this.t,this.$,this.F,this.V,n,i,e,o)}Nt(){const t=this.xt();t||it();const n=t&&new Y(t);this.$=n}xt(){if(!this.t)return null;const t=[];for(const i of tt){const n=m(i,this.t);t.push(...n)}const n=I(this.N,t);return n||this.t.querySelector("button")}$t(){this.$&&C(this.$.element,(()=>{var t;this.Nt(),l("observeAddToCartButtonRemoval found new add to cart button",this.$),c(this.A.customApiHost,"add_to_cart_button_removed",{recreated:!!this.$,theme:null==(t=window.Shopify.theme)?void 0:t.name},.01),this.Ot.updateAddToCartButton(this.$),this.$t()}))}Ft(){const t=Z.find(this.N);t&&(this.B.hideVariantPicker&&t.hide(),this.V=t)}Vt(){this.V&&C(this.V.elements()[0],(()=>{var t;this.Ft(),l("observeVariantPickerRemoval found new variant picker",this.V),c(this.A.customApiHost,"variant_picker_removed",{recreated:!!this.V,theme:null==(t=window.Shopify.theme)?void 0:t.name},.01),this.Ot.updateVariantPicker(this.V),this.Vt()}))}Ct(){let t=this.N.parentElement;for(;t;){for(const n of nt)for(const i of[...tt,"button"]){const e=f(`${n} ${i}`,t);if(e)return e.closest(n)}t=t.parentElement}if("119a01-bf.myshopify.com"===window.Shopify.shop)for(t=this.N.parentElement;t;){if(t.matches(nt[0]))return t;t=t.parentElement}return null}Tt(){const t=this.Bt(),n=I(this.N,t,6);if(!n)return;this.A.keepQuantityInput||(n.style.display="none");const i=n.matches("input")?n:n.querySelector("input");this.F=i}Pt(){this.F&&C(this.F,(()=>{var t;this.Tt(),l("observeQuantityInputRemoval found new quantity input",this.F),c(this.A.customApiHost,"quantity_input_removed",{recreated:!!this.F,theme:null==(t=window.Shopify.theme)?void 0:t.name},.01),this.Ot.updateQuantityInput(this.F),this.Pt()}))}Bt(){const t=this.A.customSelectors.quantity;if(t){const n=m(t);if(n.length)return n}for(const[n,i]of T){if(!i)continue;const t=m(i);if(t.length)return t}return m(".product-form__quantity")}At(){const t=setInterval((()=>{(void 0!==window.FastClick||void 0!==window.T4SThemeSP&&void 0!==window.T4SThemeSP.FastClick)&&(clearInterval(t),m("*",this.N).forEach((t=>{return i="needsclick",(n=t)&&n.classList.add(i);var n,i})))}),500)}}class ot{constructor(t){this.A=t,setTimeout((()=>{var n;const i=document.querySelector('link[href*="kaching-bundles-block.css"]');i?C(i,(()=>{var n;c(t.customApiHost,"css_removed",{theme:null==(n=window.Shopify.theme)?void 0:n.name})})):c(t.customApiHost,"css_not_found",{theme:null==(n=window.Shopify.theme)?void 0:n.name})}),100)}init(){this.jt();const t=m("kaching-bundle, kaching-bundle-deals");this.Dt(t),0===t.length&&this.Qt(),this.Jt(),this.A.abTestsRunning&&(async()=>{try{$();const t=F();await O()!==t&&await x(t)}catch(t){if(!(t instanceof P))throw t;console.error(t)}})()}jt(){const t=(g("script#kaching-bundles-translations")||[]).find((t=>t.locale===this.A.locale));this.O=null==t?void 0:t.translations}Dt(t){const n=g("script.kaching-bundles-product");if(n)for(const i of t)i.getAttribute("product-id")||i.setAttribute("product-id",n.id)}Qt(){if(!f("script.kaching-bundles-deal-block-settings"))return;const t=this.Rt();if(!t.length)return void it();const n=g("script.kaching-bundles-product"),i=n&&n.id||this.A.productId;for(const e of t){const t=y("kaching-bundle");t.setAttribute("product-id",i),e.parentElement.insertBefore(t,e)}}async Jt(){var t,n;const i=[...m("kaching-bundle, kaching-bundle-deals")].filter((t=>t.getAttribute("product-id")));l("_initializePlaceholders",i);if(0===i.filter((t=>!b(t).initialized)).length)return;const e=await this.Et(i);l("placeholdersData",e);const o=await this.Mt(Array.from(e.keys()),Array.from(e.values()).map((({dealBlock:t})=>t)).filter((t=>null!=t))),s=F();for(const a of i){const i=Number(a.getAttribute("product-id")),{product:u,dealBlock:d}=e.get(i);if(!u||!d)continue;setTimeout((()=>{r(this.A.shopifyDomain,d.id,i,d.abTestVariantId,s)}),2e3);const l=o.find((t=>t.id===i));l&&(this.Ut(u,l),c(this.A.customApiHost,"swatches_different_language",{language:window.Shopify.locale.split("-")[0].toUpperCase()}));const h={...{...this.A.defaultTranslations,...null==(t=this.O)?void 0:t.system},...null==(n=this.O)?void 0:n.dealBlocks[d.id]};new et(a,this.A,h,d,u)}}async Mt(t,n){if(!this.A.storefrontAccessToken)return[];if(n.map((t=>t.swatchOptions||[])).reduce(((t,n)=>t.concat(n)),[]).filter((t=>null!=t)).filter((t=>"default"!==t.swatchType)).every((t=>t.defaultLanguage===window.Shopify.locale.split("-")[0].toUpperCase())))return[];const i=await(async(t,n)=>{if(!t)return[];const i=n.map((t=>`id:${t}`)).join(" OR "),e=await fetch(`/api/${D}/graphql.json`,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Storefront-Access-Token":t},body:JSON.stringify({query:"\n        query($productsQuery: String!) {\n          products(query: $productsQuery, first: 100) {\n            edges {\n              node {\n                id\n                options {\n                  name\n                  optionValues {\n                    id\n                    name\n                  }\n                }\n              }\n            }\n          }\n        }\n      ",variables:{productsQuery:i}})});return(await e.json()).data.products.edges.map((t=>t.node)).map(L)})(this.A.storefrontAccessToken,t);return i}Ut(t,n){for(const i of n.options){const n=t.options.find((t=>t.position===i.position));if(n){n.defaultName=i.defaultName;for(const t of i.optionValues){const i=n.optionValues.find((n=>n.id===t.id));i&&(i.defaultName=t.defaultName)}}}}async Et(t){var n;const i=t.map((t=>Number(t.getAttribute("product-id")))),e=this.A.locale===this.A.liquidLocale?[...m("script.kaching-bundles-product")]:[],o=new Map(e.map((t=>[Number(b(t).productId),JSON.parse(t.textContent)]))),s=i.filter((t=>!o.has(t))),a=[...m("script.kaching-bundles-deal-block-settings")],r=new Map;for(const m of i){const t=a.filter((t=>Number(b(t).productId)===m));t.length&&r.set(m,t.map((t=>JSON.parse(t.textContent))))}const c=i.filter((t=>!r.has(t)||0===r.get(t).length||!r.get(t)[0])),u=s.length>0&&this.A.storefrontAccessToken?Q({storefrontAccessToken:this.A.storefrontAccessToken,country:window.Shopify.country,language:window.Shopify.locale.split("-")[0].toUpperCase(),productIds:s}):[],d=c.length>0?(async(t,n,i)=>n?M(n):E(t,i))(this.A.customApiHost,this.A.storefrontAccessToken,this.A.shopifyDomain):[],[l,h]=await Promise.all([u,d]),p=new Map(s.map((t=>[t,l.find((n=>n.id==t))]))),f=new Map([...o,...p]),w=F(),y=new Map;for(const m of i){const t=f.get(m),i=(null==(n=r.get(m))?void 0:n.filter((t=>t)))||h;let e=this.Lt(i,t);e=e.filter((t=>{if(!t.abTestVariantId)return!0;const n=B(w,t.abTestVariantsCount);return t.abTestVariantNumber===n})),e.length?y.set(m,{product:t,dealBlock:e[0]}):y.set(m,{product:t,dealBlock:null})}return y}Lt(t,n){const i=[],e=t.filter((t=>"selected-products"===t.blockVisibility));for(const r of e)r.selectedProductIds.map(Number).includes(n.id)&&i.push(r);const o=t.filter((t=>"selected-collections"===t.blockVisibility));for(const r of o)n.collectionIds.some((t=>r.selectedCollectionIds.map(Number).includes(t)))&&i.push(r);const s=t.filter((t=>"excluded-products"===t.blockVisibility));for(const r of s)r.excludedProductIds.map(Number).includes(n.id)||i.push(r);const a=t.filter((t=>"all-products"===t.blockVisibility));for(const r of a)i.push(r);return i}Rt(){const t=this.zt();if(t)return[t];const n=this.Gt();if(n)return[n];const i=this.Ht();return i?[i]:[]}zt(){const t=m("gp-product-button");for(const n of t)if(!n.closest("gp-sticky"))return n;return null}Gt(){for(const t of T){const n=f(t[0]);if(n){if(n.closest(".dbtfy-sticky-addtocart"))continue;return n}}return null}Ht(){for(const t of nt)for(const n of[...tt,"button"]){const i=f(`${t} ${n}`);if(i)return i.parentElement}return null}}const st=t=>{var n;801===(null==(n=window.Shopify.theme)?void 0:n.theme_store_id)?setTimeout((()=>new ot(t).init()),100):new ot(t).init()},at=()=>{if(void 0===i&&(i="off"===n()),i){const t=m("style#kaching-bundles-custom-css");for(const n of t)n.remove();return}o()&&(l("App version",S()),l("Shopify domain",window.Shopify.shop));const t=g("script#kaching-bundles-config");if(!t)return;d(t.customApiHost);const e=window.Shopify.currency;t.currencyRate=e?Number(e.rate):1,t.locale=window.Shopify.locale||t.liquidLocale,st(t),window.Shopify.designMode&&w(window,"shopify:section:load",(()=>{st(t)})),(t=>{var n;const i=document.querySelector('link[href*="kaching-bundles-block.css"]');if(!i)return;const e=i.closest('div[data-block-type="liquid"]');e&&(c(t,"impact_theme_fix",{theme:null==(n=window.Shopify.theme)?void 0:n.name}),e.dataset.blockType="liquid-kaching-fix")})(t.customApiHost)};window.kachingBundlesDisableAutoInitialize||at(),window.kachingBundlesInitialize=at}();
